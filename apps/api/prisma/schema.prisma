// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String    @id @default(uuid())
  email             String?   @unique
  nickname          String    @unique
  passwordHash      String?   @map("password_hash") // null for anonymous users
  isAnonymous       Boolean   @default(false) @map("is_anonymous")
  cpCount           Int       @default(50) @map("cp_count")
  lastCpRefillAt    DateTime  @default(now()) @map("last_cp_refill_at")
  totalPoints       BigInt    @default(0) @map("total_points")
  country           String?
  emailConsent      Boolean   @default(false) @map("email_consent")
  emailConsentAt    DateTime? @map("email_consent_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  // Relations
  wonBlocks         Block[]   @relation("BlockWinner")
  masteredBlocks    Block[]   @relation("BlockMaster")
  attempts          Attempt[]
  sessions          Session[]

  @@map("users")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  refreshToken String?  @unique @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  
  @@map("sessions")
}

model Block {
  id                 BigInt       @id @default(autoincrement())
  status             BlockStatus  @default(ACTIVE)
  seedHint           String?      @map("seed_hint")
  difficultyConfig   Json         @map("difficulty_config") // { length: number, charset: CharsetType[] }
  answerHash         String?      @map("answer_hash")
  answerPlaintext    String?      @map("answer_plaintext") // Admin only
  winnerId           String?      @map("winner_id")
  winner             User?        @relation("BlockWinner", fields: [winnerId], references: [id])
  blockMasterId      String?      @map("block_master_id")
  blockMaster        User?        @relation("BlockMaster", fields: [blockMasterId], references: [id])
  waitingStartedAt   DateTime?    @map("waiting_started_at")
  passwordRetryCount Int          @default(0) @map("password_retry_count")
  accumulatedPoints  BigInt       @default(0) @map("accumulated_points")
  previousBlockId    BigInt?      @unique @map("previous_block_id")
  previousBlock      Block?       @relation("BlockChain", fields: [previousBlockId], references: [id])
  nextBlock          Block?       @relation("BlockChain")
  solvedAttemptId    String?      @unique @map("solved_attempt_id")
  solvedAttempt      Attempt?     @relation("SolvedAttempt", fields: [solvedAttemptId], references: [id])
  attempts           Attempt[]
  createdAt          DateTime     @default(now()) @map("created_at")
  solvedAt           DateTime?    @map("solved_at")

  @@map("blocks")
}

model Attempt {
  id                String   @id @default(uuid())
  blockId           BigInt   @map("block_id")
  block             Block    @relation(fields: [blockId], references: [id], onDelete: Cascade)
  userId            String   @map("user_id")
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  inputValue        String   @map("input_value")
  similarity        Float
  isFirstSubmission Boolean  @default(false) @map("is_first_submission")
  createdAt         DateTime @default(now()) @map("created_at")
  solvedBlock      Block?   @relation("SolvedAttempt")

  @@unique([blockId, userId, inputValue], name: "unique_user_block_input")
  @@map("attempts")
}

enum BlockStatus {
  WAITING_HINT
  WAITING_PASSWORD
  ACTIVE
  SOLVED
}